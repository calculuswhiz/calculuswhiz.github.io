<!DOCTYPE html>
<html>
<head>
	<title>Scale Demo</title>
	<meta charset="utf-8">
	<script src="../../javascripts/jquery-3.3.1.min.js"></script>
	<script src="./ChromaticScale.js"></script>
	<script src="../../javascripts/Oscilloscope.js"></script>
	<link rel="stylesheet" type="text/css" href="./styles.css">
	<script>
		function ready()
		{
			try
			{
				let canvas = $('#ScopeScreen')[0];
				
				// Set up oscilloscope:
				let audioContext = new (AudioContext || webkitAudioContext)();
				let scope = new Oscilloscope(
				{ 
					audioContext : audioContext, 
					canvas : canvas,
					fftSize : Number($('#FFTMenu option:selected').val()),
					beamColor : $('#ScopeColor').val(),
					domain : Oscilloscope.domainType[$('#DomainMenu option:selected').val()]
				});
				scope.getNode().connect(audioContext.destination);
				let scaleCount = 0;
				let scaleOscillators = [];
				
				function setMessageText(text)
				{
					$('#Message').text(text);		
				}
				
	 			$('#PlayBtn').click(function ()
				{
					// Create new oscillator
					let scaleOscillator = new ChromaticScale({ audioContext : audioContext });
					scaleOscillators.push(scaleOscillator);
					
					let params = 
					{
						semitones : Number($('#Semitones').val()),
						octaves : Number($('#Octaves').val()),
						scaleBase : Number($('#ScaleBase').val()),
						startFrequency : Number($('#StartFreq').val()),
						waveType : $('#waveMenu option:selected').val(),
						msPerNote : Number($('#MsPerNote').val())
					};
					
					scaleOscillator.setProperties(params);
					scaleOscillator.turnOn();
					scaleOscillator.getNode().connect(scope.getNode());
					
					scaleOscillator.getNode().addEventListener('ended', function ()
					{
						setMessageText(`${--scaleCount} scales currently playing.`);
						if (scaleCount == 0)
						{
							scaleOscillators = [];
						}
					});
					
					setMessageText(`${++scaleCount} scales currently playing.`);
				});
				
				function stopAll()
				{
					// Rip out all connections
					scaleOscillators.forEach(function (scaleOscillator)
					{
						if (scaleOscillator != null)
						{
							scaleOscillator.turnOff();
							scaleOscillator.getNode().disconnect();
						}
					});
					scaleOscillators = [];
				}
				
				$('#StopBtn').click(function ()
				{
					stopAll();
				});
				
				$('#ResetBtn').click(function ()
				{
					stopAll();
					
					$('#Semitones').val('12');
					$('#Octaves').val('1');
					$('#ScaleBase').val('2');
					$('#StartFreq').val('440');
					$('#waveMenu').val('sine');
					$('#MsPerNote').val('250');
				});
				
				$('#ScopeColor').keyup(function ()
				{
					scope.beamColor = $('#ScopeColor').val();
				});
				
				$('#FFTMenu').change(function ()
				{
					scope.setFFTSize(Number($('#FFTMenu option:selected').val()));
				});
				
				$('#DomainMenu').change(function ()
				{
					scope.domain = Oscilloscope.domainType[$('#DomainMenu option:selected').val()];
				});
				
				$('#Activator').remove();
			}
			catch (exc)
			{
				$('body').text(exc.message);
			}
		}
	</script>
</head>
<body>
	<div id="GeneratorRoot">
		<div class="TitleLabel">Generalized Chromatic Scale Generator</div>
		<div id="ScaleController">
			<div id="ScaleParameters" class="Parameters">
				<div class="Param">
					<span class="inputLabel">Semitones</span><input type="text" id="Semitones" value="12">
				</div>
				<div class="Param">
					<span class="inputLabel">"Octaves"</span><input type="text" id="Octaves" value="1">
				</div>
				<div class="Param">
					<span class="inputLabel">Scale Base</span><input type="text" id="ScaleBase" value="2">
				</div>
				<div class="Param">
					<span class="inputLabel">Start Frequency</span><input type="text" id="StartFreq" value="440">
				</div>
				<div class="Param">
					<span class="inputLabel">Wave Type</span>
					<select id="waveMenu">
						<option value="sine">Sine</option>
						<option value="square">Square</option>
						<option value="sawtooth">Sawtooth</option>
						<option value="triangle">Triangle</option>
					</select>
				</div>
				<div class="Param">
					<span class="inputLabel">Milliseconds per note</span><input type="text" id="MsPerNote" value="250">
				</div>
			</div>
			<div id="OutputControls">
				<div>Output Controls:</div>
				<button id="PlayBtn">Play</button>
				<button id="StopBtn">Stop</button>
				<button id="ResetBtn">Reset to Defaults</button>
			</div>
		</div>
		<div id="Message">Ready!</div>
	</div>
	<div id="Scope">
		<div class="TitleLabel">Scope</div>
		<button id="Activator" onclick="ready()">Activate it!</button><br />
		<canvas id="ScopeScreen" width="1024" height="715"></canvas>
		<div>Oscilloscope Settings</div>
		<div id="ScopeParameters" class="Parameters">
			<div class="Param">
				<span class="inputLabel">Scope Color</span><input type="text" id="ScopeColor" value="rgb(0,255,0)">
			</div>
			<div class="Param">
				<span class="inputLabel">FFT Size</span>
				<select id="FFTMenu">
					<option value="1024">1024</option>
					<option value="2048" selected="selected">2048</option>
					<option value="4096">4096</option>
					<option value="8192">8192</option>
					<option value="16384">16384</option>
					<option value="32768">32768</option>
				</select>
			</div>
			<div class="Param">
				<span class="inputLabel">Domain</span>
				<select id="DomainMenu">
					<option value="time" selected="selected">Time</option>
					<option value="frequency">Frequency</option>
				</select>
			</div>
		</div>
	</div>
</body>
</html>