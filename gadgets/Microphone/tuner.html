<!DOCTYPE html>
<html>
<head>
	<title>Web Tuner</title>
	<meta charset="utf-8">
	<script src="../../javascripts/jquery-3.3.1.min.js"></script>
	<script src="../../javascripts/Pitch.js"></script>
	<script src="../../javascripts/Seismometer.js"></script>
	<script type="text/javascript">
		function ready()
		{
			let concertA = 440;
			let scale = ['A', 'A#/Bb', 'B', 'C', 'C#/Db', 'D', 'D#/Eb', 'E', 'F', 'F#/Gb', 'G', 'G#/Ab'];
			const semitones = 12;

			function rotateArray(array, amount)
			{
				amount = amount % array.length;
				if (amount === 0)
				{
					return [...array];
				}

				let right = array.slice(0, -amount);
				let left = array.slice(-amount);
				return left.concat(right);
			}

			function cycModulo(a, b)
			{
				return (a % b + b) % b;
			}

			function getNearestNote(pitch)
			{
				let stepsOff = semitones * Math.log2(pitch / concertA);
				let intStepsOff = Math.round(stepsOff);
				let noteOffset = cycModulo(intStepsOff, semitones);
				let idealFrequency = concertA * 2 ** (intStepsOff / semitones);

				return (
				{
					stepsOff : stepsOff,
					name     : scale[noteOffset] || '???',
					delta    : pitch - idealFrequency
				});
			}

			let audioContext = new (AudioContext || webkitAudioContext)();
			audioContext.sampleRate
			let tuner = new PitchAnalyser(
			{ 
				audioContext : audioContext, 
				fftSize : 4096,
				threshold : 0.4
			});
			// It will analyze without connecting to destination.

			// Set up mic gain
			let gainNode = audioContext.createGain();
			gainNode.gain.setValueAtTime(10, audioContext.currentTime);

			// Request microphone
			navigator.mediaDevices
				.getUserMedia({ audio : true })
				.then(function (stream)
				{
					let streamNode = audioContext.createMediaStreamSource(stream);
					let analyserNode = tuner.getNode();
					streamNode.connect(gainNode);
					gainNode.connect(analyserNode);
				});

			concertA = $('#ConcertA').val();
			$('#ConcertA').change(function (evt)
			{
				concertA = $(this).val();
			});

			let graphOffset = Number($('#GraphOffset').val());
			$('#GraphOffset').change(function (evt)
			{
				$(this).val($(this).val() % semitones);
				graphOffset = Number($(this).val());
				seismo.valueMap = [' ', ...rotateArray(scale, graphOffset), ' '];
			});

			let seismo = new Seismometer($('#seismo1')[0], 
			{
				yMax          : semitones + 1,
				yMin          : 0,
				numberOfLines : semitones + 1,
				maxJump       : 2,
				valueMap      : [' ', ...rotateArray(scale, graphOffset), ' ']
			});

			setInterval(function ()
			{
				let pitchData = tuner.getPitchFromSource();
				let note = getNearestNote(pitchData.pitch);

				$('#Note').text(note.name);
				$('#Delta').text(note.delta.toFixed(2));
				$('#Pitch').text(pitchData.pitch.toFixed(2));
				$('#Certainty').text((pitchData.p * 100).toFixed(2) + '%');

				// +6 so A is moved to not the bottom
				let seismoValue = (note.stepsOff === -Infinity) ? 
					-12 : 
					cycModulo(note.stepsOff + graphOffset, semitones);
				seismo.pushNewValue(seismoValue);
				seismo.render();
			}, 33.333);

			$('#Activator').remove();
		}
	</script>
</head>
<body>
	<table id="Display">
		<tbody>
			<tr>
				<td>Note</td>
				<td><span id="Note">???</span></td>
			</tr>
			<tr>
				<td>Delta</td>
				<td><span id="Delta">???</span></td>
			</tr>
			<tr>
				<td>Pitch (Hz)</td>
				<td><span id="Pitch"></span></td>
			</tr>
			<tr>
				<td>Certainty</td>
				<td><span id="Certainty"></span></td>
			</tr>
		</tbody>
	</table>
	Concert A: <input type="number" id="ConcertA" value="440"><br />
	Graph offset (half steps from A): <input type="number" id="GraphOffset" value="1"><br />
	<button id="Activator" onclick="ready()">Activate it!</button><br />
	<canvas width="600" height="800" class="seismometer" id='seismo1'></canvas>
</body>
</html>